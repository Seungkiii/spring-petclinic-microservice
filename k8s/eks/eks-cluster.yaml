apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: petclinic-cluster      # 프로젝트 명칭 통일
  region: ap-northeast-2           # 서울 리전
  version: "1.34"                 

# [핵심] Terraform으로 만든 VPC를 재사용 (새로 만들지 않음)
vpc:
  id: "<YOUR_VPC_ID>"      # Terraform Output의 vpc_id 입력
  subnets:
    # Worker Node가 배치될 Private Subnet (외부 접속 차단)
    private:
      ap-northeast-2a:
        id: "<YOUR_PRIVATE_SUBNET_ID_1>"      # Terraform Output: private_app_subnet_ids[0]
      ap-northeast-2b:             # [수정] 서울 리전은 보통 2a, 2c 사용
        id: "<YOUR_PRIVATE_SUBNET_ID_2>"      # Terraform Output: private_app_subnet_ids[1]
    
    # Load Balancer가 배치될 Public Subnet
    public:
      ap-northeast-2a:
        id: "<YOUR_PUBLIC_SUBNET_ID_1>"      # Terraform Output: public_subnet_ids[0]
      ap-northeast-2b:
        id: "<YOUR_PUBLIC_SUBNET_ID_2>"      # Terraform Output: public_subnet_ids[1]

# 관리형 노드 그룹 (EC2 Worker Nodes)
managedNodeGroups:
  - name: petclinic-ng-general-v1
    instanceType: t3.large        # 2 vCPU, 4GB RAM (가성비)
    minSize: 2
    desiredCapacity: 2             # [비용] 평소엔 2대로 유지
    maxSize: 5                     # 부하 시 최대 5대까지 확장
    privateNetworking: true        # Private Subnet에 배치 (보안 필수)
    
    # [비용 절감 핵심] Spot 인스턴스 사용
    # 운영 환경이면 onDemand 권장이나, 프로젝트 비용 절감을 위해 Spot 100% 설정
    spot: true 
    
    # [보안 & 편의성] SSH 키 대신 SSM Session Manager 사용
    # 키 파일 관리할 필요 없이 AWS 콘솔이나 터미널에서 바로 접속 가능
    ssh:
      allow: false 
    
    # [권한 설정] 노드가 AWS 서비스에 접근하기 위한 권한 (필수)
    iam:
      withAddonPolicies:
        imageBuilder: true
        autoScaler: true           # Cluster Autoscaler 사용 시 필요
        externalDNS: true
        certManager: true
        appMesh: false
        ebs: true                  # EBS 볼륨 마운트 권한 (DB나 Prometheus용)
        fsx: false
        efs: false
        albIngress: true           # AWS Load Balancer Controller 권한
        xRay: false
        cloudWatch: true           # 로그 전송 권한

    labels:
      role: worker
      environment: prod

# IRSA (IAM Roles for Service Accounts) 활성화
# 파드(Pod) 단위로 AWS 권한을 제어하기 위해 필수
iam:
  withOIDC: true

# 필수 Add-on 자동 설치
addons:
  - name: vpc-cni
  - name: coredns
  - name: kube-proxy
  - name: aws-ebs-csi-driver       # PVC(스토리지) 사용을 위해 필수