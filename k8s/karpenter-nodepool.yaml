apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: default
spec:
  template:
    spec:
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: kubernetes.io/os
          operator: In
          values: ["linux"]
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot", "on-demand"] # Spot 우선, 없으면 On-Demand
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["c", "m", "r", "t"] # c(컴퓨팅), m(범용), r(메모리) 계열 사용
        - key: karpenter.k8s.aws/instance-generation
          operator: Gt
          values: ["2"] # 구형 인스턴스 제외
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: default
  limits:
    cpu: 100
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 30s

---
apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: default
spec:
  amiFamily: AL2 # Amazon Linux 2
  
  # 실제 존재하는 노드 Role 이름
  role: "<YOUR_NODE_ROLE_ARN>"
  
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "petclinic-cluster"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "petclinic-cluster"
  amiSelectorTerms:
    - id: "<YOUR_AMI_ID>"